# baseURI: https://www.opengis.net/def/profile/skos/basics
# imports: http://datashapes.org/dash
# imports: http://www.w3.org/2004/02/skos/core

@prefix dash: <http://datashapes.org/dash#> .
@prefix dcterms: <http://purl.org/dc/terms/> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix : <https://www.opengis.net/def/profile/skos/ogc#> .
@prefix swa: <http://topbraid.org/swa#> .
@prefix tosh: <http://topbraid.org/tosh#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

<https://www.opengis.net/def/profile/skos/basics>
  a owl:Ontology ;
  owl:imports <http://datashapes.org/dash> ;
  owl:imports <http://www.w3.org/2004/02/skos/core> ;
  dcterms:creator "Rob Atkinson"
.
:NodeShape_concept
  a sh:NodeShape ;
  sh:rule :status ;
  sh:rule :inscheme ;
  sh:targetClass skos:Concept ;
.

:NodeShape_conceptscheme
  a sh:NodeShape ;
  sh:rule :topcollection ;
  sh:rule :inscheme_by_uriroot ;
  sh:rule :source_required ;
  #sh:rule :rdfslabel> ;
  sh:rule :topConcepts ;
  sh:targetClass skos:ConceptScheme ;
.

:NodeShape_collection
  a sh:NodeShape ;
        # :rdfslabel> ;
  sh:targetClass skos:Collection ;
.


:status
 a sh:SPARQLRule ;
  rdfs:label "Add status code if missing"@en;
  rdfs:comment "Assume status valid if not present.  Note original data and prior entailments for experimental resources must set status if not present"@en ;
  sh:construct """
		     PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
		     PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
			 PREFIX policy: <http://www.opengis.net/def/metamodel/ogc-na/>
		     CONSTRUCT  {
				 ?this policy:status ?status .
				}
			 WHERE {
			    ?this a skos:Concept .
			    ?this skos:inScheme ?S .
                OPTIONAL { ?this policy:status ?cstatus }
                OPTIONAL { ?S policy:status ?schemestatus }
                BIND ( COALESCE ( ?cstatus , ?schemestatus , <http://www.opengis.net/def/status/valid> ) AS ?status )
			    }
""" ;
.

:inscheme_by_uriroot
 a sh:SPARQLRule ;
  rdfs:label "Add inScheme if missing"@en;
  rdfs:comment "spin rule to create and link skos:inScheme not present. Run at conceptscheme for single pass efficiency"@en ;
  sh:construct """
		     PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
		     PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
		     CONSTRUCT  {
				 ?c skos:inScheme ?this .
				}
			 WHERE {
			    ?this a skos:ConceptScheme .
			    ?c a skos:Concept
			    FILTER ( STRSTARTS(str(?c),str(?this)) )
			    FILTER NOT EXISTS {  ?c skos:inScheme ?cs }

			    }
			""" ;
.

:inscheme
 a sh:SPARQLRule ;
  rdfs:label "Add inScheme if missing"@en;
  rdfs:comment "SHACL rule to create and link skos:inScheme if not present, based on finding a scheme with matching base URI."@en ;
  sh:construct """
		     PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
		     PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
		     CONSTRUCT  {
				 ?this skos:inScheme ?scheme .
				}
			 WHERE {
			    ?scheme a skos:ConceptScheme .
			    ?this a skos:Concept
			    FILTER ( STRSTARTS(str(?this),str(?scheme)) )
			    FILTER NOT EXISTS {  ?this skos:inScheme ?cs }

			    }
			""" ;
.

:topcollection
  a sh:SPARQLRule ;
  rdfs:label "Top level collection link"@en;
  rdfs:comment "spin rule to create and link top level Collection for a ConceptScheme if not present"@en ;
  sh:construct """
		     PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
		     PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
			 PREFIX policy: <http://www.opengis.net/def/metamodel/ogc-na/>
			 PREFIX dcterms: <http://purl.org/dc/terms/>
		     CONSTRUCT  {
		    	?tc a skos:Collection .
		    	?tc skos:definition "Collection hierarchy for this ConceptScheme" .
		    	?tc dcterms:provenance "Generated by the OGC Definitions Server to support integration of the elements of this ConceptScheme into bigger collections. ogc_skos_profile_entailements.ttl" .
				?tc skos:inScheme ?this .
				?this policy:collectionView ?tc  .
				?tc skos:member ?member .
				?tc skos:prefLabel ?defaultlabel .
				}
			 WHERE {
			    ?this a skos:ConceptScheme .
			    OPTIONAL { ?this rdfs:label ?l }
				OPTIONAL { ?this skos:prefLabel ?pl }
				OPTIONAL { ?concept skos:topConceptOf ?this
				    FILTER NOT EXISTS { ?concept skos:inScheme ?ascheme FILTER ( ?ascheme != ?this ) }
				    }
				OPTIONAL {
				  ?existing_collection a skos:Collection
				  FILTER NOT EXISTS { ?parent skos:member ?existing_collection }
				  FILTER NOT EXISTS { ?existing_collection skos:inScheme ?ascheme FILTER ( ?ascheme != ?this ) }
				}
				BIND ( CONCAT ( "Concepts in ", COALESCE(?pl, ?l, STR(?this)) ) AS ?defaultlabel )
			    BIND ( URI(CONCAT(STR(?this),"/" )) AS ?tc )
			    BIND ( COALESCE(?existing_collection, ?concept) as ?member )
			    FILTER NOT EXISTS{ ?tc a skos:Collection} .

			    }
			""" ;
.

:linktopcollection
  a sh:SPARQLRule ;
  rdfs:label "Top level collection link"@en;
  rdfs:comment "spin rule to link top level Collection for a ConceptScheme if no other collections present"@en ;
  sh:construct """
		     PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
		     PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
			 PREFIX policy: <http://www.opengis.net/def/metamodel/ogc-na/>
		     CONSTRUCT  {
		    	?tc a skos:Collection .
				?tc skos:inScheme ?this .
				?this policy:collectionView ?tc  .
				?tc skos:member ?concept .
				?tc rdfs:label ?label .
				}
			 WHERE {
			    OPTIONAL { ?this rdfs:label ?l }
				OPTIONAL { ?this skos:prefLabel ?pl }
				OPTIONAL { ?concept skos:inScheme ?this  }
				BIND ( CONCAT ( "Concepts in ", COALESCE(?pl, ?l, STR(?this)) ) AS ?defaultlabel )
			    BIND ( URI(CONCAT(STR(?this),"/" )) AS ?tc )
			    FILTER NOT EXISTS{ ?tc a skos:Collection} .
			    }
			""" ;
.

:source_required
  a sh:SPARQLRule ;
  rdfs:label "Define source if missing" ;
  sh:construct """
  PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
  prefix dcterms: <http://purl.org/dc/terms/>
  prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>
  prefix bodies: <http://www.opengis.net/def/entities/bodies/>
CONSTRUCT {
  ?this dcterms:source <http://www.opengis.net/def/entities/bodies/ogcna> .
  <http://www.opengis.net/def/entities/bodies/ogcna> a skos:Concept
}
WHERE {
  ?this a skos:ConceptScheme
  FILTER NOT EXISTS { ?this dcterms:source ?source }
    }
  """ ;
  sh:prefixes <http://purl.org/dc/terms/> ;
.


:topConcepts
  a sh:SPARQLRule ;
  rdfs:label "Add topConceptOf and hasTopConcept when no broader present" ;
  sh:order 99 ;
  sh:construct """
  PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
  CONSTRUCT {
    $this skos:hasTopConcept ?concept .
    ?concept skos:topConceptOf $this .
  } WHERE {
    { ?concept a skos:Concept ; skos:inScheme $this }
    UNION
    { ?concept skos:topConceptOf $this }
    UNION
    { $this skos:hasTopConcept ?concept }
    FILTER NOT EXISTS { ?concept skos:broader ?broader1 }
    FILTER NOT EXISTS { ?broader2 skos:narrower ?concept }
  }
  """ ;
.